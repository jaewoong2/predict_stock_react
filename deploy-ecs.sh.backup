#!/bin/bash

# ECS ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ (Docker Compose ì§€ì›)
set -e

# ìƒ‰ìƒ ì½”ë“œ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ë³€ìˆ˜ ì„¤ì •
AWS_REGION=${AWS_REGION:-"ap-northeast-2"}
AWS_PROFILE=${AWS_PROFILE:-"lime_admin"}
PROJECT_NAME="stock-predict"
ECR_REPO_NAME="${PROJECT_NAME}-app"
DOCKER_COMPOSE_FILE="docker-compose.ecs.yaml"

# í•¨ìˆ˜ ì •ì˜
log_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

log_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

log_error() {
    echo -e "${RED}âŒ $1${NC}"
}

# ì‚¬ì „ ì¡°ê±´ í™•ì¸
check_prerequisites() {
    log_info "Checking prerequisites..."
    
    # Docker ì„¤ì¹˜ í™•ì¸
    if ! command -v docker &> /dev/null; then
        log_error "Docker is not installed"
        exit 1
    fi
    
    # Docker Compose ì„¤ì¹˜ í™•ì¸
    if ! command -v docker-compose &> /dev/null && ! docker compose version &> /dev/null; then
        log_error "Docker Compose is not installed"
        exit 1
    fi
    
    # AWS CLI ì„¤ì¹˜ í™•ì¸
    if ! command -v aws &> /dev/null; then
        log_error "AWS CLI is not installed"
        exit 1
    fi
    
    # Docker Compose íŒŒì¼ ì¡´ì¬ í™•ì¸
    if [[ ! -f "$DOCKER_COMPOSE_FILE" ]]; then
        log_error "Docker Compose file not found: $DOCKER_COMPOSE_FILE"
        exit 1
    fi
    
    log_success "All prerequisites satisfied"
}

# AWS ê³„ì • ID ê°€ì ¸ì˜¤ê¸°
get_aws_account_id() {
    log_info "Getting AWS account information..."
    AWS_ACCOUNT_ID=$(aws sts get-caller-identity --profile ${AWS_PROFILE} --query Account --output text 2>/dev/null)
    if [[ $? -ne 0 ]]; then
        log_error "Failed to get AWS account ID. Check your AWS profile: ${AWS_PROFILE}"
        exit 1
    fi
    ECR_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO_NAME}"
    log_success "AWS Account ID: ${AWS_ACCOUNT_ID}"
}

# ë¡œì»¬ í…ŒìŠ¤íŠ¸ (ì˜µì…˜)
test_locally() {
    if [[ "$1" == "--test" ]]; then
        log_info "Testing application locally with Docker Compose..."
        docker-compose -f ${DOCKER_COMPOSE_FILE} down --remove-orphans 2>/dev/null || true
        docker-compose -f ${DOCKER_COMPOSE_FILE} up --build -d
        
        log_info "Waiting for application to start..."
        sleep 10
        
        # í—¬ìŠ¤ì²´í¬
        if curl -f http://localhost:3000/api/health >/dev/null 2>&1; then
            log_success "Local test passed!"
            docker-compose -f ${DOCKER_COMPOSE_FILE} logs --tail=20
        else
            log_warning "Local health check failed, but continuing..."
            docker-compose -f ${DOCKER_COMPOSE_FILE} logs --tail=20
        fi
        
        docker-compose -f ${DOCKER_COMPOSE_FILE} down
        log_info "Local test completed"
    fi
}

# AWS ê³„ì • ID ê°€ì ¸ì˜¤ê¸°
AWS_ACCOUNT_ID=$(aws sts get-caller-identity --profile ${AWS_PROFILE} --query Account --output text)
ECR_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO_NAME}"

echo "ğŸš€ Starting deployment process..."
echo "ğŸ“ Region: ${AWS_REGION}"
echo "ğŸ‘¤ Profile: ${AWS_PROFILE}"
echo "ğŸ·ï¸  ECR URI: ${ECR_URI}"

# ECR ë¡œê·¸ì¸
echo "ğŸ” Logging into ECR..."
aws ecr get-login-password --region ${AWS_REGION} --profile ${AWS_PROFILE} | docker login --username AWS --password-stdin ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com

# Docker ì´ë¯¸ì§€ ë¹Œë“œ
echo "ğŸ”¨ Building Docker image..."
docker build -f Dockerfile.ecs -t ${ECR_REPO_NAME}:latest .

# Docker ì´ë¯¸ì§€ íƒœê·¸
echo "ğŸ·ï¸  Tagging Docker image..."
docker tag ${ECR_REPO_NAME}:latest ${ECR_URI}:latest
docker tag ${ECR_REPO_NAME}:latest ${ECR_URI}:$(date +%Y%m%d%H%M%S)

# ECRì— ì´ë¯¸ì§€ í‘¸ì‹œ
echo "ğŸ“¤ Pushing Docker image to ECR..."
docker push ${ECR_URI}:latest
docker push ${ECR_URI}:$(date +%Y%m%d%H%M%S)

# ECS ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸
echo "ğŸ”„ Updating ECS service..."
aws ecs update-service \
    --cluster ${PROJECT_NAME}-cluster \
    --service ${PROJECT_NAME}-service \
    --force-new-deployment \
    --region ${AWS_REGION} \
    --profile ${AWS_PROFILE}

echo "âœ… Deployment completed successfully!"
echo "ğŸŒ Your application will be available shortly at the load balancer DNS."

# ì„ íƒì : ë°°í¬ ìƒíƒœ í™•ì¸
echo "ğŸ“Š Checking deployment status..."
aws ecs wait services-stable \
    --cluster ${PROJECT_NAME}-cluster \
    --services ${PROJECT_NAME}-service \
    --region ${AWS_REGION} \
    --profile ${AWS_PROFILE}

echo "ğŸ‰ Service is now stable and running!"
